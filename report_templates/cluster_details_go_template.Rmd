# Report 3: Cluster Details for GO-term coherent clusters
  
```{r  echo=FALSE, warning=FALSE, message=FALSE}
  metric_table <- data[['more-spec_table_metrics.txt']]
  library(dplyr)
  


  load_files <- function(data, column_names, path_column, header){
        factor_columns <- match(column_names, names(data))
        factor_combinations <- unique(data[column_names])
        
        for(row in 1:nrow(factor_combinations)){
                combination <- as.vector(t((factor_combinations[row,]))) #extract row AND convert to vector
                check_combination <- data[factor_columns] == combination[col(data[factor_columns])]
                paths <- data[[path_column]][which(apply(check_combination, 1, sum) == length(combination))]
                
                for (file_path in paths){
                  files <- read.table(file_path, sep="\t", header=header, quote="", stringsAsFactors = FALSE)
                    
                  }
                
                }
           return(files)     
        }
    
    group_clusters <- function(df){
      cluster <- unique(df$Cluster)
      all_clusters <- list()
      for (i in cluster){
        groups <- filter(df, Cluster == cluster[i])
        all_clusters[[i]] <- groups

        }
       return(all_clusters)
  }
   
    group_cluster_information <- function(df1, df2, df3, df4){
      clusters <- unique(df1$Cluster)
      all_clusters <- list()
      for (i in clusters){
        all_groups <- list()
        hp_groups <- filter(df1, Cluster == clusters[i])
        if (nrow(hp_groups) != 0){
          all_groups[["hpo"]] <- hp_groups
        }

        go_groups <- filter(df2, Cluster == clusters[i])
        if (nrow(go_groups) != 0){
          all_groups[["go"]] <- go_groups
          scores <- go_groups$Percentage_of_nodes_with_funsys
          score <- max(scores)
          all_groups[["coherence_score"]] <- score
        }else{
          all_groups[["coherence_score"]] <- 0
        }

        omim_groups <- filter(df3, Cluster == clusters[i])
        if (nrow(omim_groups) != 0){
          omim_vector_length <- c()
          
          for(omim in 1:length(omim_groups$HPOs_in_clusters)){
            nb <- strsplit(omim_groups$HPOs_in_clusters[omim], ", ")[[1]]
            omim_vector_length[omim] <- length(nb)
          }
          
          omim_index <- with(omim_groups, order(omim_vector_length, decreasing = TRUE))
          omim_groups_ordered <- omim_groups[omim_index,]
          rownames(omim_groups_ordered) <- NULL
          
          all_groups[["omim"]] <- omim_groups_ordered
        }

        name <- paste0("Cluster_", i)
        all_clusters[[name]] <- all_groups 
        }
        return(all_clusters)  
    }

```


## GO clusters

```{r  echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
  library(kableExtra)

  hpo <- load_files(metric_table, 'Type', 'Cluster_hpo_go_0.05', TRUE)
  go <- load_files(metric_table, 'Type', 'Cluster_go_0.05', TRUE)
  omim <- load_files(metric_table, 'Type', 'Cluster_omim_go_0.05', TRUE)
  
  for (i in 1:length(go$Term)){
    url <- paste0("http://amigo.geneontology.org/amigo/term/", go$Term[i])
    go$Term[i] <- text_spec(go$Term[i], link = url)
  }

    for (i in 1:length(hpo$Term)){
    url <- paste0("https://hpo.jax.org/app/browse/search?q=", hpo$Term[i], "&navFilter=all")
    hpo$Term[i] <- text_spec(hpo$Term[i], link = url)
  }
    
  for (i in 1:length(omim$Term)){
    omim_id <- unlist(strsplit(omim$Term[i], ":"))
    url <- paste0("https://www.omim.org/entry/", omim_id[2])
    omim$Term[i] <- text_spec(omim$Term[i], link = url)
  }

  all_clusters <- group_cluster_information(hpo, go, omim)

  length_vector <- c()
  for(i in 1:length(all_clusters)){
    list <- all_clusters[[i]]
    coherence_score <- list[["coherence_score"]]
    length_vector[i] <- coherence_score
    }

  ordered_clusters <- all_clusters[order(length_vector, decreasing=TRUE)]  

  for(i in 1:length(ordered_clusters)){
    list <- ordered_clusters[[i]]
    cluster_name <- names(ordered_clusters[i])
    if(!is.null(list[["go"]]) & !is.null(list[["omim"]])){
      list["coherence_score"] <- NULL
      cat(cluster_name, "\n")
      for(i in list){
        print(knitr::kable(i, format="markdown"))
        cat("\n")
      }
    }
  }

  for(i in 1:length(ordered_clusters)){
    list <- ordered_clusters[[i]]
    cluster_name <- names(ordered_clusters[i])
    if(!is.null(list[["go"]]) & is.null(list[["omim"]])){
      list["coherence_score"] <- NULL
      cat(cluster_name, "\n")
      for(i in list){
        print(knitr::kable(i, format="markdown"))
        cat("\n")
      }
    }
  }

  for(i in 1:length(ordered_clusters)){
    list <- ordered_clusters[[i]]
    cluster_name <- names(ordered_clusters[i])
    if(is.null(list[["go"]]) & !is.null(list[["omim"]])){
      list["coherence_score"] <- NULL
      cat(cluster_name, "\n")
      for(i in list){
        print(knitr::kable(i, format="markdown"))
        cat("\n")
      }
    }
  }

  for(i in 1:length(ordered_clusters)){
    list <- ordered_clusters[[i]]
    cluster_name <- names(ordered_clusters[i])
    if(is.null(list[["go"]]) & is.null(list[["omim"]])){
      list["coherence_score"] <- NULL
      cat(cluster_name, "\n")
      for(i in list){
        print(knitr::kable(i, format="markdown"))
        cat("\n")
      }
    }
  }

```